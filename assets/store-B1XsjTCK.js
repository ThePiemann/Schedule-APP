import{d as C,a as T,g as U,s as O,o as j,b as B,l as x,u as F,f as J}from"./auth-cbFyKSDW.js";let o={schedule:{},studySchedule:{},advancedTodos:[],subjectColors:{},settings:{},finance:{transactions:[],subscriptions:[],debts:[],goals:[]},notes:[],studyPlanner:{goals:[],notes:""},hobbyTracker:{hobbies:[]}},I={currentUser:null,isEvenWeek:!1};function X(t){I.currentUser=t}function D(t){if(!t)return"#F3F4F6";const n=t.trim().toUpperCase();if(o.subjectColors[n])return o.subjectColors[n];const s=`hsl(${Math.floor(Math.random()*360)}, 95%, 90%)`;return o.subjectColors[n]=s,N(),s}function _(t,n){if(!t)return null;try{if(typeof t=="object")return t;if(t.startsWith("{")){const e=JSON.parse(t);return e.type||(e.type=""),e.teacher||(e.teacher=""),e.weekType||(e.weekType="every"),(!e.color||e.color==="#F3F4F6")&&(e.color=D(e.subject)),e}}catch{}return{subject:t,start:`${n.toString().padStart(2,"0")}:00`,end:`${(n+1).toString().padStart(2,"0")}:00`,location:"",type:"",teacher:"",color:D(t),weekType:"every"}}async function z(t){if(I.currentUser)try{const n=C(T,"users",I.currentUser.uid),e=await U(n);if(e.exists()){const s=e.data();if(o.schedule=s.schedule||{},o.studySchedule=s.studySchedule||{},typeof s.advancedTodos=="string")try{o.advancedTodos=JSON.parse(s.advancedTodos)}catch{o.advancedTodos=[]}else o.advancedTodos=s.advancedTodos||[];if(typeof s.subjectColors=="string")try{o.subjectColors=JSON.parse(s.subjectColors)}catch{o.subjectColors={}}else o.subjectColors=s.subjectColors||{};if(typeof s.finance=="string")try{o.finance=JSON.parse(s.finance)}catch{o.finance={transactions:[],subscriptions:[],debts:[],goals:[]}}else o.finance=s.finance||{transactions:[],subscriptions:[],debts:[],goals:[]};if(typeof s.notes=="string")try{o.notes=JSON.parse(s.notes)}catch{o.notes=[]}else o.notes=s.notes||[];if(typeof s.studyPlanner=="string")try{o.studyPlanner=JSON.parse(s.studyPlanner)}catch{o.studyPlanner={goals:[],notes:""}}else o.studyPlanner=s.studyPlanner||{goals:[],notes:""};if(typeof s.hobbyTracker=="string")try{o.hobbyTracker=JSON.parse(s.hobbyTracker)}catch{o.hobbyTracker={hobbies:[]}}else o.hobbyTracker=s.hobbyTracker||{hobbies:[]};o.settings=s.settings||{},console.log("Data loaded from Cloud"),t&&t()}else console.log("New user - starting with empty data."),N()}catch(n){console.error("Error loading data:",n)}}async function N(){if(!I.currentUser)return;const t={schedule:o.schedule,studySchedule:o.studySchedule,advancedTodos:JSON.stringify(o.advancedTodos),subjectColors:JSON.stringify(o.subjectColors),finance:JSON.stringify(o.finance||{transactions:[],subscriptions:[],debts:[],goals:[]}),notes:JSON.stringify(o.notes||[]),studyPlanner:JSON.stringify(o.studyPlanner||{goals:[],notes:""}),hobbyTracker:JSON.stringify(o.hobbyTracker||{hobbies:[]}),lastUpdated:new Date().toISOString()};try{await O(C(T,"users",I.currentUser.uid),t,{merge:!0}),console.log("Saved to Cloud...")}catch(n){console.error("Error saving data:",n)}}window.saveUserData=N;let c={},S=null;document.addEventListener("DOMContentLoaded",()=>{R()});function R(){j(B,async t=>{t&&(console.log("Settings: User authenticated."),S=C(T,"users",t.uid),await W(t))}),$(),H()}async function W(t){try{const n=await U(S);if(n.exists()){const e=n.data();c={...e.settings||{},userProfileImage:e.settings?.userProfileImage||null},o&&(o.settings={...c}),E(c),G(t,c),k(),p("settingThemeToggle",c.isDarkMode==="true"),p("settingVibrantToggle",c.isVibrant==="true"),p("settingWeatherToggle",c.isWeatherEnabled==="true"),p("settingSplitBillToggle",c.showSplitBill==="true"),p("settingShowWeekCounter",c.showWeekCounter==="true"),p("settingEvenOddToggle",c.isEvenOddEnabled==="true");const s=document.getElementById("currencySelect");if(s&&(s.value=c.preferredCurrency||"USD"),c.userProfileImage){const a=document.getElementById("currentProfileImg"),r=document.getElementById("defaultProfileIcon");a&&r&&(a.src=c.userProfileImage,a.classList.remove("hidden"),r.classList.add("hidden"))}}}catch(n){console.error(n)}}async function g(t,n){if(S){c[t]=n,o&&o.settings&&(o.settings[t]=n);try{const e={};e[`settings.${t}`]=n,await F(S,e),window.dispatchEvent(new Event("settingsChanged"))}catch(e){console.error(`Failed to save ${t}:`,e)}(t==="userProfileImage"||t==="userFirstName"||t==="userLastName")&&k()}}function k(){const t=document.getElementById("navProfileImg"),n=document.getElementById("navProfileIcon"),e=document.getElementById("menuProfileImg"),s=document.getElementById("menuProfileIcon"),a=document.getElementById("menuUserName"),r=c.userProfileImage;r?(t&&(t.src=r,t.classList.remove("hidden")),n&&n.classList.add("hidden"),e&&(e.src=r,e.classList.remove("hidden")),s&&s.classList.add("hidden")):(t&&t.classList.add("hidden"),n&&n.classList.remove("hidden"),e&&e.classList.add("hidden"),s&&s.classList.remove("hidden")),a&&(c.userFirstName?a.innerText=c.userFirstName:B.currentUser&&B.currentUser.displayName?a.innerText=B.currentUser.displayName.split(" ")[0]:a.innerText="Student")}function b(t,n,e,s=!1){let a=document.getElementById("confirmationModal");if(!a)return alert(n);const r=document.getElementById("confirmModalTitle"),i=document.getElementById("confirmModalMessage"),f=document.getElementById("confirmModalBtn"),u=document.getElementById("cancelConfirmModalBtn");if(r&&(r.innerText=t),i&&(i.innerText=n),f){const d=f.cloneNode(!0);f.parentNode.replaceChild(d,f),d.addEventListener("click",()=>{e(),a.classList.add("hidden"),a.classList.remove("flex")}),s?(d.classList.remove("bg-primary","hover:bg-blue-600"),d.classList.add("bg-red-500","hover:bg-red-600")):(d.classList.remove("bg-red-500","hover:bg-red-600"),d.classList.add("bg-primary","hover:bg-blue-600"))}if(u){const d=u.cloneNode(!0);u.parentNode.replaceChild(d,u),d.addEventListener("click",()=>{a.classList.add("hidden"),a.classList.remove("flex")})}a.classList.remove("hidden"),a.classList.add("flex")}function $(){m("settingThemeToggle",i=>{g("isDarkMode",i?"true":"false"),E({...c,isDarkMode:i?"true":"false"})}),m("settingVibrantToggle",i=>{g("isVibrant",i?"true":"false"),E({...c,isVibrant:i?"true":"false"})}),m("settingWeatherToggle",i=>{g("isWeatherEnabled",i?"true":"false"),typeof handleWeatherToggle=="function"&&handleWeatherToggle(i)}),m("settingSplitBillToggle",i=>{g("showSplitBill",i?"true":"false"),typeof handleSplitBillToggle=="function"&&handleSplitBillToggle(i)}),m("settingShowWeekCounter",i=>{g("showWeekCounter",i?"true":"false")}),m("settingEvenOddToggle",i=>{g("isEvenOddEnabled",i?"true":"false")}),m("settingMotionToggle",i=>{g("reduceMotion",i?"true":"false"),E({...c,reduceMotion:i?"true":"false"})}),document.querySelectorAll(".theme-btn").forEach(i=>{i.addEventListener("click",f=>{const u=f.target.dataset.theme;g("appAccent",u),E({...c,appAccent:u})})});const n=document.getElementById("signOutBtn");n&&n.addEventListener("click",async()=>{await x(),window.location.href="/pages/login/"});const e=document.getElementById("deleteAccountBtn");e&&e.addEventListener("click",async()=>{b("Delete Account?","This action is permanent and cannot be undone.",async()=>{const i=await J();i.success?(alert("Account deleted."),window.location.href="/pages/signup/"):alert("Error: "+i.errorMessage)},!0)});const s=document.getElementById("settingsModal"),a=document.getElementById("closeSettingsModal");["settingsBtn","sidebarSettingsBtn","dropdownSettingsBtn"].forEach(i=>{const f=document.getElementById(i);f&&s&&f.addEventListener("click",()=>{A("Account"),s.classList.remove("hidden"),s.classList.add("flex")})}),a&&s&&a.addEventListener("click",()=>{s.classList.add("hidden"),s.classList.remove("flex")}),Y()}function m(t,n){const e=document.getElementById(t);e&&e.addEventListener("change",s=>n(s.target.checked))}function p(t,n){const e=document.getElementById(t);e&&(e.checked=n)}function E(t){const n=document.documentElement,e=t.isDarkMode==="true",s=t.isVibrant==="true",a=t.appAccent||"blue",r=t.reduceMotion==="true";e?n.classList.add("dark"):n.classList.remove("dark"),s?n.classList.add("vibrant"):n.classList.remove("vibrant"),n.setAttribute("data-theme",a),r?n.setAttribute("data-motion","reduce"):n.removeAttribute("data-motion"),document.querySelectorAll(".theme-btn").forEach(i=>{i.dataset.theme===a?i.classList.add("ring-2","ring-gray-400"):i.classList.remove("ring-2","ring-gray-400")})}const P={USD:1,EUR:.92,GBP:.79,JPY:150,CAD:1.36,AUD:1.52,INR:83,KHR:4100};function v(t,n,e){if(n===e)return t;const s=parseFloat(t);return isNaN(s)?0:s/(P[n]||1)*(P[e]||1)}function V(t,n){o.finance&&(console.log(`Converting data from ${t} to ${n}...`),o.finance.transactions&&(o.finance.transactions=o.finance.transactions.map(e=>({...e,amount:v(e.amount,t,n)}))),o.finance.subscriptions&&(o.finance.subscriptions=o.finance.subscriptions.map(e=>({...e,cost:v(e.cost,t,n)}))),o.finance.debts&&(o.finance.debts=o.finance.debts.map(e=>({...e,amount:v(e.amount,t,n)}))),o.finance.goals&&(o.finance.goals=o.finance.goals.map(e=>({...e,target:v(e.target,t,n)}))),o.finance.budget&&(o.finance.budget=v(o.finance.budget,t,n)),saveUserData(),window.dispatchEvent(new Event("settingsChanged")))}function Y(){const t=document.getElementById("firstNameInput"),n=document.getElementById("lastNameInput"),e=document.getElementById("currencySelect"),s=document.getElementById("saveProfileBtn"),a=document.getElementById("pomoDurationInput"),r=document.getElementById("shortDurationInput"),i=document.getElementById("longDurationInput"),f=document.getElementById("saveStudySettingsBtn");e&&e.addEventListener("change",async u=>{const d=c.preferredCurrency||"USD",l=u.target.value;d!==l&&(o&&o.settings&&(o.settings.preferredCurrency=l),c.preferredCurrency=l,V(d,l),await g("preferredCurrency",l))}),s&&s.addEventListener("click",()=>{const u=Date.now(),d=c.lastNameChange?parseInt(c.lastNameChange):0,l=10080*60*1e3;if(u-d<l){const y=Math.ceil((d+l-u)/864e5);b("Cooldown Active",`You can change your profile again in ${y} days.`,()=>{},!1);return}b("Change Name?","You won't be able to change your name again for 7 days.",async()=>{t&&await g("userFirstName",t.value),n&&await g("userLastName",n.value),await g("lastNameChange",u.toString()),b("Success!","Your profile has been updated.",()=>{},!1)},!1)}),f&&f.addEventListener("click",()=>{a&&g("pomoDuration",a.value),r&&g("shortDuration",r.value),i&&g("longDuration",i.value),b("Timer Updated!","Your study durations have been saved.",()=>{},!1)}),q()}function G(t,n){const e=document.getElementById("settingsEmailDisplay");e&&t.email&&(e.value=t.email);const s=document.getElementById("firstNameInput"),a=document.getElementById("lastNameInput");let r=n.userFirstName,i=n.userLastName;if(!r&&t.displayName){const l=t.displayName.split(" ");r=l[0],i=l.slice(1).join(" ")}s&&(s.value=r||""),a&&(a.value=i||"");const f=document.getElementById("pomoDurationInput"),u=document.getElementById("shortDurationInput"),d=document.getElementById("longDurationInput");f&&(f.value=n.pomoDuration||25),u&&(u.value=n.shortDuration||5),d&&(d.value=n.longDuration||15)}function q(){const t=document.getElementById("uploadProfileBtn"),n=document.getElementById("removeProfileBtn"),e=document.getElementById("uploadProfileInput"),s=document.getElementById("currentProfileImg"),a=document.getElementById("defaultProfileIcon"),r=document.getElementById("cropModal"),i=document.getElementById("cropImageToEdit"),f=document.getElementById("confirmCropBtn"),u=document.getElementById("cancelCropBtn"),d=document.getElementById("closeCropBtn");let l=null;t&&e&&t.addEventListener("click",()=>e.click()),e&&e.addEventListener("change",L=>{const h=L.target.files[0];if(h){const w=new FileReader;w.onload=M=>{i.src=M.target.result,r.classList.remove("hidden"),r.classList.add("flex"),l&&l.destroy(),l=new Cropper(i,{aspectRatio:1,viewMode:1})},w.readAsDataURL(h)}L.target.value=""});const y=()=>{r.classList.add("hidden"),r.classList.remove("flex"),l&&(l.destroy(),l=null)};f&&f.addEventListener("click",()=>{if(!l)return;const h=l.getCroppedCanvas({width:300,height:300}).toDataURL();g("userProfileImage",h),s&&a&&(s.src=h,s.classList.remove("hidden"),a.classList.add("hidden")),y()}),u&&u.addEventListener("click",y),d&&d.addEventListener("click",y),n&&n.addEventListener("click",()=>{confirm("Remove profile picture?")&&(g("userProfileImage",null),s&&a&&(s.src="",s.classList.add("hidden"),a.classList.remove("hidden")))})}function H(){["Account","Study","Schedule","Notifications","Theme","About"].forEach(n=>{const e=document.getElementById(`setBtn${n}`);e&&e.addEventListener("click",()=>A(n))})}function A(t){["Account","Study","Schedule","Notifications","Theme","About"].forEach(e=>{const s=document.getElementById(`setBtn${e}`),a=document.getElementById(`setSection${e}`);e===t?(s&&s.classList.add("active"),a&&a.classList.remove("hidden")):(s&&s.classList.remove("active"),a&&a.classList.add("hidden"))})}export{I as appState,D as getSubjectColor,z as loadUserData,_ as parseSlotData,N as saveUserData,X as setCurrentUser,o as userData};
