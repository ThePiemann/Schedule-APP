import{o as D,d as L,a as b,b as P,g as S,l as U,f as O,u as B,s as M}from"./auth-cbFyKSDW.js";let r={},m=null;document.addEventListener("DOMContentLoaded",()=>{j()});function j(){D(P,async t=>{t&&(console.log("Settings: User authenticated."),m=L(b,"users",t.uid),await F(t))}),W(),q()}async function F(t){try{const n=await S(m);if(n.exists()){const e=n.data();if(r={...e.settings,userProfileImage:e.settings?.userProfileImage||null},y(r),J(t,r),g("settingThemeToggle",r.isDarkMode==="true"),g("settingVibrantToggle",r.isVibrant==="true"),g("settingWeatherToggle",r.isWeatherEnabled==="true"),g("settingSplitBillToggle",r.showSplitBill==="true"),g("settingShowWeekCounter",r.showWeekCounter==="true"),g("settingEvenOddToggle",r.isEvenOddEnabled==="true"),r.userProfileImage){const s=document.getElementById("currentProfileImg"),o=document.getElementById("defaultProfileIcon");s&&o&&(s.src=r.userProfileImage,s.classList.remove("hidden"),o.classList.add("hidden"))}}}catch(n){console.error(n)}}async function l(t,n){if(m){r[t]=n;try{const e={};e[`settings.${t}`]=n,await B(m,e)}catch(e){console.error(`Failed to save ${t}:`,e)}(t==="userProfileImage"||t==="userFirstName"||t==="userLastName")&&R();try{const e={};e[`settings.${t}`]=n,await B(m,e)}catch(e){console.error(e)}}}function R(){const t=document.getElementById("navProfileImg"),n=document.getElementById("navProfileIcon"),e=document.getElementById("menuProfileImg"),s=document.getElementById("menuProfileIcon"),o=document.getElementById("menuUserName"),c=r.userProfileImage;c?(t&&(t.src=c,t.classList.remove("hidden")),n&&n.classList.add("hidden"),e&&(e.src=c,e.classList.remove("hidden")),s&&s.classList.add("hidden")):(t&&t.classList.add("hidden"),n&&n.classList.remove("hidden"),e&&e.classList.add("hidden"),s&&s.classList.remove("hidden")),o&&r.userFirstName&&(o.innerText=`${r.userFirstName} ${r.userLastName||""}`)}function W(){f("settingThemeToggle",a=>{l("isDarkMode",a?"true":"false"),y({...r,isDarkMode:a?"true":"false"})}),f("settingVibrantToggle",a=>{l("isVibrant",a?"true":"false"),y({...r,isVibrant:a?"true":"false"})}),f("settingWeatherToggle",a=>{l("isWeatherEnabled",a?"true":"false"),typeof handleWeatherToggle=="function"&&handleWeatherToggle(a)}),f("settingSplitBillToggle",a=>{l("showSplitBill",a?"true":"false"),typeof handleSplitBillToggle=="function"&&handleSplitBillToggle(a)}),f("settingShowWeekCounter",a=>{l("showWeekCounter",a?"true":"false")}),f("settingEvenOddToggle",a=>{l("isEvenOddEnabled",a?"true":"false")}),f("settingMotionToggle",a=>{l("reduceMotion",a?"true":"false"),y({...r,reduceMotion:a?"true":"false"})}),document.querySelectorAll(".theme-btn").forEach(a=>{a.addEventListener("click",d=>{const p=d.target.dataset.theme;l("appAccent",p),y({...r,appAccent:p})})});const n=document.getElementById("signOutBtn");n&&n.addEventListener("click",async()=>{await U(),window.location.href="/pages/login/"});const e=document.getElementById("deleteAccountBtn");e&&e.addEventListener("click",async()=>{if(confirm("DANGER: Are you sure? This will permanently delete your account.")){const a=await O();a.success?(alert("Account deleted."),window.location.href="/pages/signup/"):alert("Error: "+a.errorMessage)}});const s=document.getElementById("settingsBtn"),o=document.getElementById("settingsModal"),c=document.getElementById("closeSettingsModal");s&&o&&s.addEventListener("click",()=>{A("Account"),o.classList.remove("hidden"),o.classList.add("flex")}),c&&o&&c.addEventListener("click",()=>{o.classList.add("hidden"),o.classList.remove("flex")}),x(),V()}function f(t,n){const e=document.getElementById(t);e&&e.addEventListener("change",s=>n(s.target.checked))}function g(t,n){const e=document.getElementById(t);e&&(e.checked=n)}function y(t){const n=document.documentElement,e=t.isDarkMode==="true",s=t.isVibrant==="true",o=t.appAccent||"blue",c=t.reduceMotion==="true";e?n.classList.add("dark"):n.classList.remove("dark"),s?n.classList.add("vibrant"):n.classList.remove("vibrant"),n.setAttribute("data-theme",o),c?n.setAttribute("data-motion","reduce"):n.removeAttribute("data-motion"),document.querySelectorAll(".theme-btn").forEach(a=>{a.dataset.theme===o?a.classList.add("ring-2","ring-gray-400"):a.classList.remove("ring-2","ring-gray-400")})}function x(){const t=document.getElementById("firstNameInput"),n=document.getElementById("lastNameInput");let e=null;const s=(o,c)=>{clearTimeout(e),e=setTimeout(()=>l(o,c),1e3)};t&&t.addEventListener("input",o=>s("userFirstName",o.target.value)),n&&n.addEventListener("input",o=>s("userLastName",o.target.value)),$()}function J(t,n){const e=document.getElementById("settingsEmailDisplay");e&&t.email&&(e.value=t.email);const s=document.getElementById("firstNameInput"),o=document.getElementById("lastNameInput");s&&n.userFirstName&&(s.value=n.userFirstName),o&&n.userLastName&&(o.value=n.userLastName)}function $(){const t=document.getElementById("uploadProfileBtn"),n=document.getElementById("removeProfileBtn"),e=document.getElementById("uploadProfileInput"),s=document.getElementById("currentProfileImg"),o=document.getElementById("defaultProfileIcon"),c=document.getElementById("cropModal"),a=document.getElementById("cropImageToEdit"),d=document.getElementById("confirmCropBtn"),p=document.getElementById("cancelCropBtn"),N=document.getElementById("closeCropBtn");let u=null;t&&e&&t.addEventListener("click",()=>e.click()),e&&e.addEventListener("change",I=>{const h=I.target.files[0];if(h){const C=new FileReader;C.onload=k=>{a.src=k.target.result,c.classList.remove("hidden"),c.classList.add("flex"),u&&u.destroy(),u=new Cropper(a,{aspectRatio:1,viewMode:1})},C.readAsDataURL(h)}I.target.value=""});const E=()=>{c.classList.add("hidden"),c.classList.remove("flex"),u&&(u.destroy(),u=null)};d&&d.addEventListener("click",()=>{if(!u)return;const h=u.getCroppedCanvas({width:300,height:300}).toDataURL();l("userProfileImage",h),s&&o&&(s.src=h,s.classList.remove("hidden"),o.classList.add("hidden")),E()}),p&&p.addEventListener("click",E),N&&N.addEventListener("click",E),n&&n.addEventListener("click",()=>{confirm("Remove profile picture?")&&(l("userProfileImage",null),s&&o&&(s.src="",s.classList.add("hidden"),o.classList.remove("hidden")))})}function V(){const t=document.getElementById("exportDataBtn");t&&t.addEventListener("click",async()=>{if(!m){alert("Not synced yet.");return}const s=await S(m);if(s.exists()){const o=s.data(),c=new Blob([JSON.stringify(o)],{type:"application/json"}),a=URL.createObjectURL(c),d=document.createElement("a");d.href=a,d.download="studentdash_cloud_backup.json",d.click()}});const n=document.getElementById("importDataBtn"),e=document.getElementById("importDataInput");n&&e&&(n.addEventListener("click",()=>e.click()),e.addEventListener("change",s=>{const o=s.target.files[0];if(!o)return;const c=new FileReader;c.onload=async a=>{try{const d=JSON.parse(a.target.result);confirm("Importing data will OVERWRITE your Cloud data. Continue?")&&(await B(m,d),alert("Data imported! Reloading..."),location.reload())}catch{alert("Invalid data file.")}},c.readAsText(o),s.target.value=""}))}function q(){["Account","Schedule","Notifications","Theme","About"].forEach(n=>{const e=document.getElementById(`setBtn${n}`);e&&e.addEventListener("click",()=>A(n))})}function A(t){["Account","Schedule","Notifications","Theme","About"].forEach(e=>{const s=document.getElementById(`setBtn${e}`),o=document.getElementById(`setSection${e}`);e===t?(s&&s.classList.add("active"),o&&o.classList.remove("hidden")):(s&&s.classList.remove("active"),o&&o.classList.add("hidden"))})}let i={schedule:{},advancedTodos:[],subjectColors:{},settings:{},finance:{transactions:[],subscriptions:[],debts:[],goals:[]},notes:[]},v={currentUser:null,isEvenWeek:!1};function _(t){v.currentUser=t}function w(t){if(!t)return"#F3F4F6";const n=t.trim().toUpperCase();if(i.subjectColors[n])return i.subjectColors[n];const s=`hsl(${Math.floor(Math.random()*360)}, 95%, 90%)`;return i.subjectColors[n]=s,T(),s}function z(t,n){if(!t)return null;try{if(typeof t=="object")return t;if(t.startsWith("{")){const e=JSON.parse(t);return e.type||(e.type=""),e.teacher||(e.teacher=""),e.weekType||(e.weekType="every"),(!e.color||e.color==="#F3F4F6")&&(e.color=w(e.subject)),e}}catch{}return{subject:t,start:`${n.toString().padStart(2,"0")}:00`,end:`${(n+1).toString().padStart(2,"0")}:00`,location:"",type:"",teacher:"",color:w(t),weekType:"every"}}async function K(t){if(v.currentUser)try{const n=L(b,"users",v.currentUser.uid),e=await S(n);if(e.exists()){const s=e.data();if(i.schedule=s.schedule||{},typeof s.advancedTodos=="string")try{i.advancedTodos=JSON.parse(s.advancedTodos)}catch{i.advancedTodos=[]}else i.advancedTodos=s.advancedTodos||[];if(typeof s.subjectColors=="string")try{i.subjectColors=JSON.parse(s.subjectColors)}catch{i.subjectColors={}}else i.subjectColors=s.subjectColors||{};if(typeof s.finance=="string")try{i.finance=JSON.parse(s.finance)}catch{i.finance={transactions:[],subscriptions:[],debts:[],goals:[]}}else i.finance=s.finance||{transactions:[],subscriptions:[],debts:[],goals:[]};if(typeof s.notes=="string")try{i.notes=JSON.parse(s.notes)}catch{i.notes=[]}else i.notes=s.notes||[];i.settings=s.settings||{},console.log("Data loaded from Cloud"),t&&t()}else console.log("New user - starting with empty data."),T()}catch(n){console.error("Error loading data:",n)}}async function T(){if(!v.currentUser)return;const t={schedule:i.schedule,advancedTodos:JSON.stringify(i.advancedTodos),subjectColors:JSON.stringify(i.subjectColors),finance:JSON.stringify(i.finance||{transactions:[],subscriptions:[],debts:[],goals:[]}),notes:JSON.stringify(i.notes||[]),lastUpdated:new Date().toISOString()};try{await M(L(b,"users",v.currentUser.uid),t,{merge:!0}),console.log("Saved to Cloud...")}catch(n){console.error("Error saving data:",n)}}window.saveUserData=T;export{v as appState,w as getSubjectColor,K as loadUserData,z as parseSlotData,T as saveUserData,_ as setCurrentUser,i as userData};
