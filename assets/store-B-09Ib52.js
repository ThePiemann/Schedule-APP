import{d as S,a as N,g as P,s as U,o as k,b as E,l as O,u as j,f as x}from"./auth-cbFyKSDW.js";let i={schedule:{},studySchedule:{},advancedTodos:[],subjectColors:{},settings:{},finance:{transactions:[],subscriptions:[],debts:[],goals:[]},notes:[],studyPlanner:{goals:[],notes:""}},I={currentUser:null,isEvenWeek:!1};function G(e){I.currentUser=e}function w(e){if(!e)return"#F3F4F6";const s=e.trim().toUpperCase();if(i.subjectColors[s])return i.subjectColors[s];const n=`hsl(${Math.floor(Math.random()*360)}, 95%, 90%)`;return i.subjectColors[s]=n,C(),n}function z(e,s){if(!e)return null;try{if(typeof e=="object")return e;if(e.startsWith("{")){const t=JSON.parse(e);return t.type||(t.type=""),t.teacher||(t.teacher=""),t.weekType||(t.weekType="every"),(!t.color||t.color==="#F3F4F6")&&(t.color=w(t.subject)),t}}catch{}return{subject:e,start:`${s.toString().padStart(2,"0")}:00`,end:`${(s+1).toString().padStart(2,"0")}:00`,location:"",type:"",teacher:"",color:w(e),weekType:"every"}}async function K(e){if(I.currentUser)try{const s=S(N,"users",I.currentUser.uid),t=await P(s);if(t.exists()){const n=t.data();if(i.schedule=n.schedule||{},i.studySchedule=n.studySchedule||{},typeof n.advancedTodos=="string")try{i.advancedTodos=JSON.parse(n.advancedTodos)}catch{i.advancedTodos=[]}else i.advancedTodos=n.advancedTodos||[];if(typeof n.subjectColors=="string")try{i.subjectColors=JSON.parse(n.subjectColors)}catch{i.subjectColors={}}else i.subjectColors=n.subjectColors||{};if(typeof n.finance=="string")try{i.finance=JSON.parse(n.finance)}catch{i.finance={transactions:[],subscriptions:[],debts:[],goals:[]}}else i.finance=n.finance||{transactions:[],subscriptions:[],debts:[],goals:[]};if(typeof n.notes=="string")try{i.notes=JSON.parse(n.notes)}catch{i.notes=[]}else i.notes=n.notes||[];if(typeof n.studyPlanner=="string")try{i.studyPlanner=JSON.parse(n.studyPlanner)}catch{i.studyPlanner={goals:[],notes:""}}else i.studyPlanner=n.studyPlanner||{goals:[],notes:""};i.settings=n.settings||{},console.log("Data loaded from Cloud"),e&&e()}else console.log("New user - starting with empty data."),C()}catch(s){console.error("Error loading data:",s)}}async function C(){if(!I.currentUser)return;const e={schedule:i.schedule,studySchedule:i.studySchedule,advancedTodos:JSON.stringify(i.advancedTodos),subjectColors:JSON.stringify(i.subjectColors),finance:JSON.stringify(i.finance||{transactions:[],subscriptions:[],debts:[],goals:[]}),notes:JSON.stringify(i.notes||[]),studyPlanner:JSON.stringify(i.studyPlanner||{goals:[],notes:""}),lastUpdated:new Date().toISOString()};try{await U(S(N,"users",I.currentUser.uid),e,{merge:!0}),console.log("Saved to Cloud...")}catch(s){console.error("Error saving data:",s)}}window.saveUserData=C;let c={},B=null;document.addEventListener("DOMContentLoaded",()=>{F()});function F(){k(E,async e=>{e&&(console.log("Settings: User authenticated."),B=S(N,"users",e.uid),await W(e))}),J(),Y()}async function W(e){try{const s=await P(B);if(s.exists()){const t=s.data();if(c={...t.settings||{},userProfileImage:t.settings?.userProfileImage||null},i&&(i.settings={...c}),v(c),R(e,c),D(),p("settingThemeToggle",c.isDarkMode==="true"),p("settingVibrantToggle",c.isVibrant==="true"),p("settingWeatherToggle",c.isWeatherEnabled==="true"),p("settingSplitBillToggle",c.showSplitBill==="true"),p("settingShowWeekCounter",c.showWeekCounter==="true"),p("settingEvenOddToggle",c.isEvenOddEnabled==="true"),c.userProfileImage){const n=document.getElementById("currentProfileImg"),o=document.getElementById("defaultProfileIcon");n&&o&&(n.src=c.userProfileImage,n.classList.remove("hidden"),o.classList.add("hidden"))}}}catch(s){console.error(s)}}async function m(e,s){if(B){c[e]=s,i&&i.settings&&(i.settings[e]=s);try{const t={};t[`settings.${e}`]=s,await j(B,t),window.dispatchEvent(new Event("settingsChanged"))}catch(t){console.error(`Failed to save ${e}:`,t)}(e==="userProfileImage"||e==="userFirstName"||e==="userLastName")&&D()}}function D(){const e=document.getElementById("navProfileImg"),s=document.getElementById("navProfileIcon"),t=document.getElementById("menuProfileImg"),n=document.getElementById("menuProfileIcon"),o=document.getElementById("menuUserName"),r=c.userProfileImage;r?(e&&(e.src=r,e.classList.remove("hidden")),s&&s.classList.add("hidden"),t&&(t.src=r,t.classList.remove("hidden")),n&&n.classList.add("hidden")):(e&&e.classList.add("hidden"),s&&s.classList.remove("hidden"),t&&t.classList.add("hidden"),n&&n.classList.remove("hidden")),o&&(c.userFirstName?o.innerText=c.userFirstName:E.currentUser&&E.currentUser.displayName?o.innerText=E.currentUser.displayName.split(" ")[0]:o.innerText="Student")}function y(e,s,t,n=!1){let o=document.getElementById("confirmationModal");if(!o)return alert(s);const r=document.getElementById("confirmModalTitle"),a=document.getElementById("confirmModalMessage"),d=document.getElementById("confirmModalBtn"),u=document.getElementById("cancelConfirmModalBtn");if(r&&(r.innerText=e),a&&(a.innerText=s),d){const l=d.cloneNode(!0);d.parentNode.replaceChild(l,d),l.addEventListener("click",()=>{t(),o.classList.add("hidden"),o.classList.remove("flex")}),n?(l.classList.remove("bg-primary","hover:bg-blue-600"),l.classList.add("bg-red-500","hover:bg-red-600")):(l.classList.remove("bg-red-500","hover:bg-red-600"),l.classList.add("bg-primary","hover:bg-blue-600"))}if(u){const l=u.cloneNode(!0);u.parentNode.replaceChild(l,u),l.addEventListener("click",()=>{o.classList.add("hidden"),o.classList.remove("flex")})}o.classList.remove("hidden"),o.classList.add("flex")}function J(){g("settingThemeToggle",a=>{m("isDarkMode",a?"true":"false"),v({...c,isDarkMode:a?"true":"false"})}),g("settingVibrantToggle",a=>{m("isVibrant",a?"true":"false"),v({...c,isVibrant:a?"true":"false"})}),g("settingWeatherToggle",a=>{m("isWeatherEnabled",a?"true":"false"),typeof handleWeatherToggle=="function"&&handleWeatherToggle(a)}),g("settingSplitBillToggle",a=>{m("showSplitBill",a?"true":"false"),typeof handleSplitBillToggle=="function"&&handleSplitBillToggle(a)}),g("settingShowWeekCounter",a=>{m("showWeekCounter",a?"true":"false")}),g("settingEvenOddToggle",a=>{m("isEvenOddEnabled",a?"true":"false")}),g("settingMotionToggle",a=>{m("reduceMotion",a?"true":"false"),v({...c,reduceMotion:a?"true":"false"})}),document.querySelectorAll(".theme-btn").forEach(a=>{a.addEventListener("click",d=>{const u=d.target.dataset.theme;m("appAccent",u),v({...c,appAccent:u})})});const s=document.getElementById("signOutBtn");s&&s.addEventListener("click",async()=>{await O(),window.location.href="/pages/login/"});const t=document.getElementById("deleteAccountBtn");t&&t.addEventListener("click",async()=>{y("Delete Account?","This action is permanent and cannot be undone.",async()=>{const a=await x();a.success?(alert("Account deleted."),window.location.href="/pages/signup/"):alert("Error: "+a.errorMessage)},!0)});const n=document.getElementById("settingsModal"),o=document.getElementById("closeSettingsModal");["settingsBtn","sidebarSettingsBtn","dropdownSettingsBtn"].forEach(a=>{const d=document.getElementById(a);d&&n&&d.addEventListener("click",()=>{M("Account"),n.classList.remove("hidden"),n.classList.add("flex")})}),o&&n&&o.addEventListener("click",()=>{n.classList.add("hidden"),n.classList.remove("flex")}),$()}function g(e,s){const t=document.getElementById(e);t&&t.addEventListener("change",n=>s(n.target.checked))}function p(e,s){const t=document.getElementById(e);t&&(t.checked=s)}function v(e){const s=document.documentElement,t=e.isDarkMode==="true",n=e.isVibrant==="true",o=e.appAccent||"blue",r=e.reduceMotion==="true";t?s.classList.add("dark"):s.classList.remove("dark"),n?s.classList.add("vibrant"):s.classList.remove("vibrant"),s.setAttribute("data-theme",o),r?s.setAttribute("data-motion","reduce"):s.removeAttribute("data-motion"),document.querySelectorAll(".theme-btn").forEach(a=>{a.dataset.theme===o?a.classList.add("ring-2","ring-gray-400"):a.classList.remove("ring-2","ring-gray-400")})}function $(){const e=document.getElementById("firstNameInput"),s=document.getElementById("lastNameInput"),t=document.getElementById("saveProfileBtn"),n=document.getElementById("pomoDurationInput"),o=document.getElementById("shortDurationInput"),r=document.getElementById("longDurationInput"),a=document.getElementById("saveStudySettingsBtn");t&&t.addEventListener("click",()=>{const d=Date.now(),u=c.lastNameChange?parseInt(c.lastNameChange):0,l=10080*60*1e3;if(d-u<l){const f=Math.ceil((u+l-d)/864e5);y("Cooldown Active",`You can change your name again in ${f} days.`,()=>{},!1);return}y("Change Name?","You won't be able to change your name again for 7 days.",()=>{e&&m("userFirstName",e.value),s&&m("userLastName",s.value),m("lastNameChange",d.toString()),y("Success!","Your profile has been updated.",()=>{},!1)},!1)}),a&&a.addEventListener("click",()=>{n&&m("pomoDuration",n.value),o&&m("shortDuration",o.value),r&&m("longDuration",r.value),y("Timer Updated!","Your study durations have been saved.",()=>{},!1)}),V()}function R(e,s){const t=document.getElementById("settingsEmailDisplay");t&&e.email&&(t.value=e.email);const n=document.getElementById("firstNameInput"),o=document.getElementById("lastNameInput");let r=s.userFirstName,a=s.userLastName;if(!r&&e.displayName){const f=e.displayName.split(" ");r=f[0],a=f.slice(1).join(" ")}n&&(n.value=r||""),o&&(o.value=a||"");const d=document.getElementById("pomoDurationInput"),u=document.getElementById("shortDurationInput"),l=document.getElementById("longDurationInput");d&&(d.value=s.pomoDuration||25),u&&(u.value=s.shortDuration||5),l&&(l.value=s.longDuration||15)}function V(){const e=document.getElementById("uploadProfileBtn"),s=document.getElementById("removeProfileBtn"),t=document.getElementById("uploadProfileInput"),n=document.getElementById("currentProfileImg"),o=document.getElementById("defaultProfileIcon"),r=document.getElementById("cropModal"),a=document.getElementById("cropImageToEdit"),d=document.getElementById("confirmCropBtn"),u=document.getElementById("cancelCropBtn"),l=document.getElementById("closeCropBtn");let f=null;e&&t&&e.addEventListener("click",()=>t.click()),t&&t.addEventListener("change",b=>{const h=b.target.files[0];if(h){const T=new FileReader;T.onload=A=>{a.src=A.target.result,r.classList.remove("hidden"),r.classList.add("flex"),f&&f.destroy(),f=new Cropper(a,{aspectRatio:1,viewMode:1})},T.readAsDataURL(h)}b.target.value=""});const L=()=>{r.classList.add("hidden"),r.classList.remove("flex"),f&&(f.destroy(),f=null)};d&&d.addEventListener("click",()=>{if(!f)return;const h=f.getCroppedCanvas({width:300,height:300}).toDataURL();m("userProfileImage",h),n&&o&&(n.src=h,n.classList.remove("hidden"),o.classList.add("hidden")),L()}),u&&u.addEventListener("click",L),l&&l.addEventListener("click",L),s&&s.addEventListener("click",()=>{confirm("Remove profile picture?")&&(m("userProfileImage",null),n&&o&&(n.src="",n.classList.add("hidden"),o.classList.remove("hidden")))})}function Y(){["Account","Study","Schedule","Notifications","Theme","About"].forEach(s=>{const t=document.getElementById(`setBtn${s}`);t&&t.addEventListener("click",()=>M(s))})}function M(e){["Account","Study","Schedule","Notifications","Theme","About"].forEach(t=>{const n=document.getElementById(`setBtn${t}`),o=document.getElementById(`setSection${t}`);t===e?(n&&n.classList.add("active"),o&&o.classList.remove("hidden")):(n&&n.classList.remove("active"),o&&o.classList.add("hidden"))})}export{I as appState,w as getSubjectColor,K as loadUserData,z as parseSlotData,C as saveUserData,G as setCurrentUser,i as userData};
